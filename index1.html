<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic AI Healthcare Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #3b82f6; /* Blue-500 (Close to MEDICAS teal) */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #eff6ff; /* Blue-50 */
        }
        
        /* New Primary Color: Deep Teal/Blue to match MEDICAS feel (Used for main buttons, focus rings, etc.) */
        .primary-color {
            background-color: #1e88e5; /* A vibrant blue, close to the theme */
        }
        .text-primary-color {
            color: #1e88e5;
        }
        .border-primary-color {
            border-color: #1e88e5;
        }

        /* Custom styling for the primary action card (Dashboard) */
        .primary-action-card {
            background-color: #ecfeff; /* Light Cyan/Teal background */
            border: 2px solid #67e8f9; /* Cyan-300 border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .primary-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.4), 0 4px 6px -2px rgba(6, 182, 212, 0.2); /* Cyan-600 shadow */
        }
        
        /* Style for the active tab in the main content area */
        .tab-active {
            border-bottom: 3px solid #1e88e5; /* Primary Color */
            color: #1e88e5;
            font-weight: 600;
        }
        /* File upload box style */
        .file-upload-box {
            border: 2px dashed #93c5fd; /* Blue-300 */
            transition: all 0.2s ease;
        }
        .file-upload-box:hover {
            border-color: #1e88e5; /* Primary Color */
            background-color: #f0f9ff; /* Blue-50 */
        }

        /* --- STYLING TO MATCH THE REFERENCED IMAGE (Appointment Slots) --- */
        
        /* Container for AI Slots - Light background with soft rounded corners */
        .ai-slot-container {
            background-color: #f7f5ff; /* Very light purple/white */
            border-radius: 12px;
            padding: 20px;
        }

        /* Base Slot Button Style */
        .slot-btn {
            background-color: #e0e7ff; /* Lighter purple/blue for unselected */
            color: #4f46e5; /* Deep purple text for unselected */
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            white-space: normal; 
            text-align: center;
            display: inline-block;
        }
        
        /* Selected Slot Button Style (Deep Purple from the image) */
        .slot-btn.selected {
            background-color: #5846f5; /* Deep purple/blue, like the image */
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(88, 70, 245, 0.5), 0 2px 4px -2px rgba(88, 70, 245, 0.3);
            transform: translateY(-1px);
        }
        
        /* Confirm Booking Button Style (Wide, Deep Purple) */
        .confirm-btn-style {
            background-color: #5846f5; /* Matching Deep Purple */
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 16px 24px;
            border-radius: 12px;
            transition: background-color 0.2s;
            box-shadow: 0 10px 15px -3px rgba(88, 70, 245, 0.5);
        }
        .confirm-btn-style:hover:not(:disabled) {
             background-color: #4d3be3;
        }
        .confirm-btn-style:disabled {
            background-color: #a5b4fc; /* Light purple when disabled */
            box-shadow: none;
            cursor: not-allowed;
        }
        
        /* Specific styling for prediction result severity */
        .severity-urgent {
            border-left-color: #ef4444; /* Red */
        }
        .severity-moderate {
            border-left-color: #f59e0b; /* Amber */
        }
        .severity-default {
            border-left-color: #1e88e5; /* Primary Color */
        }
        
        /* Styling for the Top Matches List */
        .match-list li:nth-child(1) { font-weight: 700; color: #1e88e5; }
        .match-list li:nth-child(2) { color: #22c55e; }
        .match-list li:nth-child(3) { color: #f97316; }
        
        /* --- STYLING TO MATCH THE REFERENCED IMAGE (Specialty Cards) --- */
        .specialty-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .specialty-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        .specialty-image {
            width: 100%;
            height: 200px; /* Fixed height for image consistency */
            object-fit: cover;
        }
        .book-now-btn {
            background-color: #2dd4bf; /* Teal-400 (matches the image's button color) */
            color: white;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .book-now-btn:hover {
            background-color: #0d9488; /* Teal-600 */
        }

        /* --- STYLING TO MATCH THE REFERENCED IMAGE (Footer/Teal Bar) --- */
        .medicas-footer {
            background-color: #1e8585; /* Deep Teal */
            color: white;
            padding: 40px 0;
            margin-top: auto; /* Push footer to the bottom */
        }
        .medicas-footer a {
            color: #e0f2f1; /* Light cyan links */
            transition: color 0.2s;
        }
        .medicas-footer a:hover {
            color: white;
            text-decoration: underline;
        }

    </style>
</head>
<body class="bg-gray-50 font-sans antialiased min-h-screen flex flex-col">

    <script type="module">
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging firestore issues
        setLogLevel('Debug');

        // Initialize Firebase
        let app, db, auth;
        let currentUserId = 'Loading...';

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token or anonymously
                const signInPromise = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
                    ? signInWithCustomToken(auth, __initial_auth_token)
                    : signInAnonymously(auth);

                signInPromise
                    .then(() => {
                        console.log("Firebase Auth: Sign-in successful.");
                        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                        document.getElementById('user-id-display').textContent = currentUserId;
                    })
                    .catch((error) => {
                        console.error("Firebase Auth Error:", error);
                        currentUserId = crypto.randomUUID();
                        document.getElementById('user-id-display').textContent = currentUserId;
                    });
            } else {
                console.warn("Firebase config is missing. Firestore operations will not work.");
                currentUserId = crypto.randomUUID();
                document.getElementById('user-id-display').textContent = currentUserId;
            }
        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            currentUserId = crypto.randomUUID();
            document.getElementById('user-id-display').textContent = currentUserId;
        }
    </script>

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img src="https://placehold.co/40x40/1e88e5/ffffff?text=M" alt="Medicas Logo" class="w-7 h-7 mr-2">
                <span class="text-xl font-extrabold text-gray-800">MEDICAS Health</span>
            </div>

            <nav class="hidden md:flex space-x-8">
                <a href="#" class="nav-link text-gray-600 hover:text-primary-color font-medium transition duration-150 py-1" data-view="dashboard">Home</a>
                <a href="#" class="nav-link text-gray-600 hover:text-primary-color font-medium transition duration-150 py-1" data-view="appointments">Appointments</a>
                <a href="#" class="nav-link text-gray-600 hover:text-primary-color font-medium transition duration-150 py-1" data-view="records">Records</a>
                <a href="#" class="nav-link text-gray-600 hover:text-primary-color font-medium transition duration-150 py-1" data-view="refills">Refills</a>
            </nav>

            <div class="flex items-center space-x-4">
                <button onclick="changeView('skin-check')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-indigo-500/50 transition duration-300 flex items-center text-sm">
                    <i data-lucide="scan" class="w-4 h-4 mr-2"></i>
                    AI Skin Check
                </button>
                <div class="hidden lg:block">
                    <p class="text-xs font-medium text-gray-500">User ID:</p>
                    <code id="user-id-display" class="text-xs text-indigo-600 break-all bg-indigo-50 p-1 rounded-md">Loading...</code>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 custom-scrollbar">

        <h1 id="page-title" class="text-3xl font-extrabold text-gray-800 mb-8 border-b pb-2">Patient Dashboard</h1>

        <div class="md:hidden mb-6">
            <select id="mobile-nav" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color shadow-sm">
                <option value="dashboard">Dashboard</option>
                <option value="skin-check">AI Skin Check</option>
                <option value="appointments">Appointments</option>
                <option value="telehealth">Telehealth Join</option>
                <option value="records">Medical Records</option>
                <option value="refills">Prescription Refills</option>
            </select>
        </div>

        <div id="dashboard-view" class="view-content">
            
            <div class="primary-color text-white p-8 rounded-xl shadow-xl mb-10 flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-3xl sm:text-4xl font-extrabold leading-tight">
                        Revolutionizing the Way <span class="text-cyan-300">Healthcare Is Delivered</span>
                    </h2>
                    <p class="text-cyan-100 text-lg mt-2">Everything you need to know in minutes, backed by AI insights.</p>
                </div>
                <i data-lucide="activity-square" class="w-12 h-12 text-white"></i>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

                <div onclick="changeView('skin-check')" class="primary-action-card p-6 rounded-xl cursor-pointer text-gray-800 flex flex-col items-center text-center">
                    <i data-lucide="scan-face" class="w-10 h-10 text-cyan-600 mb-3"></i>
                    <h2 class="text-xl font-bold mb-1">AI Skin Check</h2>
                    <p class="text-gray-600 text-sm">Upload a photo for instant, preliminary diagnosis.</p>
                </div>

                <div onclick="changeView('appointments')" class="primary-action-card p-6 rounded-xl cursor-pointer text-gray-800 flex flex-col items-center text-center">
                    <i data-lucide="calendar-check" class="w-10 h-10 text-cyan-600 mb-3"></i>
                    <h2 class="text-xl font-bold text-gray-700 mb-1">Book Appointment</h2>
                    <p class="text-gray-600 text-sm">Schedule a video session with a specialist.</p>
                </div>

                <div onclick="changeView('telehealth')" class="primary-action-card p-6 rounded-xl cursor-pointer text-gray-800 flex flex-col items-center text-center">
                    <i data-lucide="video" class="w-10 h-10 text-cyan-600 mb-3"></i>
                    <h2 class="text-xl font-bold text-gray-700 mb-1">Telehealth Join</h2>
                    <p class="text-gray-600 text-sm">Access your video session with your doctor.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="bell" class="w-5 h-5 mr-2 text-red-500"></i>
                        Priority Alerts & Next Steps
                    </h3>
                    <ul class="space-y-4">
                        <li id="reschedule-reminder-alert" class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 flex justify-between items-center">
                            <span class="font-medium">REMINDER:</span> Your appointment with Dr. Piyush Gupta is tomorrow at 4:30 PM.
                            <button class="text-red-600 text-sm hover:underline" onclick="rescheduleAppointment('reschedule-reminder-alert')">Reschedule?</button>
                        </li>
                        <li id="refill-amoxicillin-alert-dashboard" class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 flex justify-between items-center">
                            <span class="font-medium">ACTION REQUIRED:</span> Prescription refill for Amoxicillin is due in 3 days.
                            <button class="text-yellow-600 text-sm hover:underline" onclick="requestRefillAction('refill-amoxicillin-alert-dashboard')">Request Refill</button>
                            </li>
                        <li class="p-3 bg-primary-color/10 border border-primary-color/30 rounded-lg text-primary-color">
                            <span class="font-medium">AI INSIGHT:</span> Your recent health data suggests an optimized follow-up schedule.
                        </li>
                    </ul>
                </div>
                
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="user" class="w-5 h-5 mr-2 text-primary-color"></i>
                        My Details
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3 p-3 bg-primary-color/10 rounded-lg border border-primary-color/30">
                            <i data-lucide="id-card" class="w-6 h-6 text-primary-color"></i>
                            <div>
                                <p class="text-xs font-medium text-gray-500">Patient ID</p>
                                <p class="font-semibold text-gray-800">2315800036</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <i data-lucide="graduation-cap" class="w-6 h-6 text-primary-color"></i>
                            <div>
                                <p class="text-xs font-medium text-gray-500">Clinic Status</p>
                                <p class="font-semibold text-gray-800">Student (GLAU)</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <i data-lucide="user-check" class="w-6 h-6 text-primary-color"></i>
                            <div>
                                <p class="text-xs font-medium text-gray-500">Primary Doctor</p>
                                <p class="font-semibold text-gray-800">Dr.Piyush Gupta (Dermatology)</p>
                            </div>
                        </div>
                        </div>
                </div>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i data-lucide="stethoscope" class="w-6 h-6 mr-2 text-primary-color"></i>
                Schedule a Video Consultation With a Specialist Today
            </h3>
            
            <div id="specialties-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <div class="specialty-card">
                    <img src="https://placehold.co/600x200/e0f2f1/047857?text=General+Practioner" alt="General Practitioner" class="specialty-image">
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">General Practitioner</h4>
                        <p class="text-sm text-gray-600 mb-4">Consult for cold, flu, fever, headache, stomach ache, migraine and more.</p>
                        <div class="flex justify-between items-center border-t pt-3">
                            <div>
                                <p class="text-sm font-semibold text-gray-600">Next available at</p>
                                <p class="text-sm font-bold text-red-500" id="gp-slot-time">Loading...</p>
                            </div>
                            <button onclick="changeViewAndSelectSpecialty('appointments', 'General Physician')" class="book-now-btn">Book Now</button>
                        </div>
                    </div>
                </div>

                <div class="specialty-card">
                    <img src="https://placehold.co/600x200/f0f9ff/0e7490?text=Pediatrics" alt="Pediatrics" class="specialty-image">
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Pediatrics</h4>
                        <p class="text-sm text-gray-600 mb-4">Consult for children's health like fever, cough, running nose, urinary tract infection, loose motions, vomiting and more.</p>
                        <div class="flex justify-between items-center border-t pt-3">
                            <div>
                                <p class="text-sm font-semibold text-gray-600">Next available at</p>
                                <p class="text-sm font-bold text-red-500" id="pediatrics-slot-time">Loading...</p>
                            </div>
                            <button onclick="changeViewAndSelectSpecialty('appointments', 'Pediatrics')" class="book-now-btn">Book Now</button>
                        </div>
                    </div>
                </div>

                <div class="specialty-card">
                    <img src="https://placehold.co/600x200/fff7ed/ea580c?text=Dermatology" alt="Dermatology" class="specialty-image">
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Dermatology</h4>
                        <p class="text-sm text-gray-600 mb-4">Consult for hair fall, dandruff, pimples, acne skin conditions, sexually transmitted diseases and more.</p>
                        <div class="flex justify-between items-center border-t pt-3">
                            <div>
                                <p class="text-sm font-semibold text-gray-600">Next available at</p>
                                <p class="text-sm font-bold text-red-500" id="dermatology-slot-time">Loading...</p>
                            </div>
                            <button onclick="changeViewAndSelectSpecialty('appointments', 'Dermatology')" class="book-now-btn">Book Now</button>
                        </div>
                    </div>
                </div>

                <div class="specialty-card">
                    <img src="https://placehold.co/600x200/f0f9ff/0891b2?text=Obstetrics+Gynecology" alt="Obstetrics Gynecology" class="specialty-image">
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Obstetrics Gynecology</h4>
                        <p class="text-sm text-gray-600 mb-4">Consult for pregnancy conditions and regular checkups, irregular periods, cramps, fertility issues, vaccination, infections, thyroid conditions and more.</p>
                        <div class="flex justify-between items-center border-t pt-3">
                            <div>
                                <p class="text-sm font-semibold text-gray-600">Next available at</p>
                                <p class="text-sm font-bold text-red-500" id="obgyn-slot-time">Loading...</p>
                            </div>
                            <button onclick="changeViewAndSelectSpecialty('appointments', 'Obstetrics Gynecology')" class="book-now-btn">Book Now</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        
        <div id="skin-check-view" class="view-content hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <i data-lucide="scan-face" class="w-6 h-6 mr-3 text-primary-color"></i>
                    Step 1: AI Skin Disease Screening
                </h2>
                <p class="text-gray-500 mb-6">Upload a clear photo or video of the area of concern. Our AI analyzes both visual features (image) and verbal descriptions (video/audio).</p>

                <div id="upload-container" class="transition-all duration-300">
                    <label for="skin-image-upload" class="file-upload-box flex flex-col items-center justify-center p-12 rounded-xl cursor-pointer bg-gray-50">
                        <i data-lucide="camera" class="w-12 h-12 text-blue-400 mb-3"></i>
                        <p class="text-gray-700 font-bold">Click to Upload Image or Video</p>
                        <p class="text-sm text-gray-500 mt-1">Accepted: PNG, JPG, MP4, MOV (Max 5MB)</p>
                        <input type="file" id="skin-image-upload" accept="image/png, image/jpeg, image/jpg, video/mp4, video/quicktime" class="hidden" onchange="handleImageUpload(event)">
                    </label>
                </div>
                
                <div id="loading-indicator" class="hidden mt-8 text-center p-8 bg-gray-100 rounded-xl">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-color border-t-transparent rounded-full mb-3"></div>
                    <p class="text-primary-color font-semibold" id="loading-message">Analyzing media with VGG19 model... Please wait.</p>
                </div>

                <div id="prediction-results" class="hidden mt-8 transition-all duration-500">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <h3 class="text-lg font-medium text-gray-700 mb-3" id="media-title">Your Upload (Image)</h3>
                            <div id="preview-container" class="w-full h-auto object-cover rounded-xl shadow-xl border-4 border-primary-color/50 overflow-hidden">
                                <img id="image-preview" src="" alt="Skin Lesion" class="w-full h-auto object-cover">
                                <video id="video-preview" src="" controls class="w-full h-auto object-cover hidden"></video>
                            </div>
                        </div>
                        
                        <div id="ai-result-card" class="md:col-span-2 bg-primary-color/10 p-6 rounded-xl border border-primary-color/30 shadow-inner">
                            <h3 class="text-lg font-bold text-primary-color mb-3 flex items-center">
                                <i data-lucide="brain-circuit" class="w-5 h-5 mr-3"></i>
                                AI Screening Result
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-sm text-gray-600 font-medium">Predicted Condition (Best Match):</p>
                                    <p class="text-3xl font-extrabold text-primary-color" id="ai-prediction-condition">N/A</p>
                                    <p class="text-lg text-primary-color/70 font-semibold">Confidence: <span id="ai-prediction-confidence">0%</span></p>
                                </div>
                                
                                <div id="severity-box" class="bg-white p-3 rounded-lg border-l-4 severity-default">
                                    <p class="text-sm text-gray-700 font-semibold flex items-center">
                                        Severity: <span id="ai-severity" class="font-extrabold ml-1">N/A</span>
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1" id="ai-recommendation">Disclaimer: This is NOT a diagnosis. Always consult a licensed medical professional.</p>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <p class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <i data-lucide="list-ordered" class="w-4 h-4 mr-1 text-gray-500"></i>
                                        Top 5 Similarity Matches
                                    </p>
                                    <ul id="top-matches-list" class="match-list text-xs space-y-1">
                                        <li class="text-gray-500">No matches yet.</li>
                                    </ul>
                                </div>

                                <div id="transcript-display" class="hidden bg-gray-100 p-3 rounded-lg">
                                    <p class="text-xs font-medium text-gray-700 mb-1">Extracted Description (Whisper):</p>
                                    <p class="text-sm text-gray-600 italic break-words" id="extracted-text">...</p>
                                </div>

                                <button onclick="changeView('appointments')" class="bg-green-600 hover:bg-green-700 w-full mt-4 text-white font-semibold py-3 px-4 rounded-xl text-lg flex items-center justify-center shadow-md shadow-green-500/50 transition">
                                    <i data-lucide="calendar-plus" class="w-5 h-5 mr-2"></i>
                                    Step 2: Book Doctor Appointment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="appointments-view" class="view-content hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <i data-lucide="calendar-check" class="w-6 h-6 mr-3 text-primary-color"></i>
                    Schedule Appointment
                </h2>
                <p class="text-gray-500 mb-8">
                    Our AI scheduling engine finds the best available slots based on your health needs.
                </p>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-4">
                        <label class="block">
                            <span class="text-gray-700 font-medium">Select Doctor/Speciality</span>
                            <select id="specialty-select" onchange="loadSuggestedSlots()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-primary-color focus:border-primary-color">
                                <option value="Dermatology">Dermatology (Recommended for Skin Check)</option>
                                <option value="General Physician">General Physician</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Obstetrics Gynecology">Obstetrics Gynecology</option>
                            </select>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">Reason for Visit</span>
                            <textarea id="reason-for-visit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-primary-color focus:border-primary-color" rows="3" placeholder="E.g., Follow-up on AI result for Psoriasis prediction"></textarea>
                        </label>

                        <div class="ai-slot-container">
                            <p class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                                <i data-lucide="clock-4" class="w-5 h-5 mr-2"></i>
                                AI Suggested Appointment Slots:
                            </p>
                            <div id="slot-container" class="flex flex-wrap gap-3 mb-2">
                                <p class="text-gray-600 italic">Loading slots...</p>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">Best match considers doctor specialization and time preference (4 PM).</p>
                        </div>
                        
                        <button id="confirm-booking-btn" onclick="showConfirmation()" class="confirm-btn-style w-full mt-4" disabled>
                            Select a Slot to Confirm Booking
                        </button>
                    </div>

                    <div class="lg:col-span-1 bg-gray-50 p-5 rounded-xl border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">My Bookings</h3>
                        <ul id="appointment-list" class="space-y-3">
                            <li class="p-3 bg-white rounded-lg border flex justify-between items-center shadow-sm">
                                <div>
                                    <p class="font-medium text-gray-600">Completed: Dr. K. Patel</p>
                                    <p class="text-sm text-gray-500">15 Nov, 11:00 AM (GP)</p>
                                </div>
                                <button class="text-primary-color hover:text-indigo-700 text-sm" onclick="changeView('records')">View Record</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="telehealth-view" class="view-content hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <i data-lucide="video" class="w-6 h-6 mr-3 text-red-600"></i>
                    Step 3: Join Your Telehealth Session
                </h2>
                
                <div class="mb-8 border-b pb-4">
                    <p class="text-lg font-medium text-gray-700">Doctor: <span id="telehealth-doctor">N/A</span></p>
                    <p class="text-lg font-medium text-gray-700">Scheduled: <span class="font-bold text-red-600" id="telehealth-datetime">N/A</span></p>
                    <p class="text-sm text-gray-500 mt-1">Consultation ID: <span id="telehealth-id">#AGHA...</span></p>

                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl text-lg mt-4 shadow-lg shadow-red-500/50 transition duration-300">
                        Join Session Now
                    </button>
                </div>

                <div class="p-6 bg-red-50 rounded-xl border border-red-200">
                    <h3 class="text-xl font-bold text-red-800 mb-4 flex items-center">
                        <i data-lucide="camera-off" class="w-5 h-5 mr-2"></i>
                        Uploaded Media History (Visible to Doctor)
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">
                        This is the image/video history that the doctor reviews before and during your consultation.
                    </p>
                    <div id="doctor-shared-media" class="w-full bg-gray-200 h-64 rounded-xl flex items-center justify-center p-2 shadow-inner">
                        <img id="shared-image-preview" src="https://placehold.co/400x300/fecaca/991b1b?text=Image+Not+Uploaded+Yet" alt="Shared media for doctor" class="max-h-full max-w-full object-contain rounded-lg shadow-md">
                        <video id="shared-video-preview" src="" controls class="w-full h-auto object-cover rounded-lg shadow-md hidden"></video>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Source: <span id="shared-image-source">N/A</span> (Uploaded: <span id="shared-image-date">N/A</span>)</p>
                    
                    <div id="shared-transcript-info" class="mt-4 hidden">
                        <p class="text-xs font-medium text-red-700">Transcription Data Shared:</p>
                        <p class="text-sm text-red-600 italic break-words" id="shared-transcript-text">No transcript available.</p>
                    </div>
                </div>

            </div>
        </div>

        <div id="records-view" class="view-content hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Medical Records History</h2>
                <p class="text-gray-500">All your past visit summaries, diagnoses, and test results are securely stored here.</p>
                
                <div class="mt-6 p-5 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                        Consultation Record: Dr. K. Patel
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Date: 15 Nov, 2025 | Type: General Physician Follow-up</p>
                    <div class="space-y-3">
                        <p><span class="font-semibold text-gray-700">Chief Complaint:</span> Minor cold symptoms (cough, mild fever).</p>
                        <p><span class="font-semibold text-gray-700">Diagnosis:</span> Common Cold (Acute Viral Rhinitis).</p>
                        <p><span class="font-semibold text-gray-700">Treatment Plan:</span> Rest, increased fluid intake, Tylenol as needed for fever.</p>
                        <p class="text-xs text-gray-500 border-t pt-2 mt-2">Notes: Patient advised to isolate for 48 hours and return if symptoms worsen.</p>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-gray-100 rounded-lg text-gray-600">
                    *Placeholder for detailed electronic health records (older visits)*
                </div>
            </div>
        </div>

        <div id="refills-view" class="view-content hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Prescription Refill Manager</h2>
                <p class="text-gray-500 mb-6">Manage your active prescriptions and request renewals instantly, pending doctor approval.</p>
                
                <div class="space-y-4">
                    
                    <div id="refill-amoxicillin" class="p-4 bg-yellow-50 border border-yellow-300 rounded-lg flex justify-between items-center shadow-sm">
                        <div>
                            <p class="text-lg font-bold text-yellow-800">Amoxicillin (500mg)</p>
                            <p class="text-sm text-gray-600">Prescribed by: Dr. K. Patel (GP)</p>
                            <p class="text-xs text-red-500 font-medium mt-1">Refill Due: 3 days left</p>
                        </div>
                        <button 
                            class="refill-btn bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition"
                            onclick="requestRefill('Amoxicillin', 'refill-amoxicillin')"
                        >
                            Request Refill
                        </button>
                    </div>

                    <div id="refill-cetirizine" class="p-4 bg-green-50 border border-green-300 rounded-lg flex justify-between items-center shadow-sm">
                        <div>
                            <p class="text-lg font-bold text-green-800">Cetirizine (10mg)</p>
                            <p class="text-sm text-gray-600">Prescribed by: Dr. J. Sharma (Dermatology)</p>
                            <p class="text-xs text-green-700 font-medium mt-1">Refills Remaining: 5</p>
                        </div>
                        <button 
                            class="refill-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition"
                            onclick="requestRefill('Cetirizine', 'refill-cetirizine')"
                        >
                            Request Refill
                        </button>
                    </div>

                    <div class="p-4 bg-gray-100 border border-gray-300 rounded-lg flex justify-between items-center shadow-sm opacity-70">
                        <div>
                            <p class="text-lg font-bold text-gray-500">Ibuprofen (200mg)</p>
                            <p class="text-sm text-gray-500">Prescribed by: Dr. K. Patel (GP)</p>
                            <p class="text-xs text-gray-500 font-medium mt-1">Status: Expired</p>
                        </div>
                        <button class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>
                            Expired
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>

        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all scale-100">
                <h3 id="modal-title" class="text-2xl font-bold text-primary-color mb-4 flex items-center">
                    <i data-lucide="check-circle" class="w-6 h-6 mr-2"></i>
                    Success!
                </h3>
                <p id="modal-message" class="text-gray-700 mb-6">Your appointment has been successfully booked for December 1st at 4:30 PM. Check the Telehealth tab for details.</p>
                <button onclick="hideModal()" class="bg-primary-color hover:bg-indigo-700 w-full text-white font-semibold py-3 px-4 rounded-lg shadow-md transition">
                    Acknowledge
                </button>
            </div>
        </div>

    </main>

    <footer class="medicas-footer">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-8 border-b border-white/30 pb-6">
                <div class="flex items-center mb-3">
                    <img src="https://placehold.co/40x40/1e88e5/ffffff?text=M" alt="Medicas Logo" class="w-8 h-8 mr-2 bg-white rounded-full p-1">
                    <span class="text-2xl font-extrabold text-white">MEDICAS</span>
                </div>
                <p class="text-sm text-white/90 max-w-3xl">Medicas delivers quality healthcare thatâ€™s affordable, accessible, and always within reach. From trusted doctors to personalised diagnostics, experience seamless care whenever and wherever you need it.</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-8">
                <div>
                    <h5 class="text-lg font-bold mb-4 text-white">SERVICES</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-white">Online Doctor Consultation</a></li>
                        <li><a href="#" class="hover:text-white">Book Lab Tests at Home</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-bold mb-4 text-white">QUICK LINKS</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-white">Home</a></li>
                        <li><a href="#" class="hover:text-white">About Us</a></li>
                        <li><a href="#" class="hover:text-white">Instant Video Consult</a></li>
                        <li><a href="#" class="hover:text-white">Book Lab Test</a></li>
                        <li><a href="#" class="hover:text-white">Health Packages</a></li>
                        <li><a href="#" class="hover:text-white">Health Calculators</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-bold mb-4 text-white">RESOURCES</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-white">Health Updates</a></li>
                        <li><a href="#" class="hover:text-white">Customer Testimonials</a></li>
                        <li><a href="#" class="hover:text-white">Mobile App - Android</a></li>
                        <li><a href="#" class="hover:text-white">Mobile App - iOS</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-bold mb-4 text-white">LAB TESTS</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-white">Glucose Random RBS</a></li>
                        <li><a href="#" class="hover:text-white">Glycosylated HbA1C</a></li>
                        <li><a href="#" class="hover:text-white">Erythrocyte Sedimentation Rate ESR</a></li>
                        <li><a href="#" class="hover:text-white">Glucose Fasting FBS</a></li>
                        <li><a href="#" class="hover:text-white">Thyroid Peroxidase Antibodies TPO Microsomal</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-bold mb-4 text-white">CONTACT US</h5>
                    <ul class="space-y-2 text-sm">
                        <li>info@medicasapp.com</li>
                        <li>India : +91 933918 04395</li>
                    </ul>
                    <h5 class="text-lg font-bold mt-6 mb-3 text-white">FOR MORE UPDATES</h5>
                    <div class="flex space-x-3">
                        <a href="#" class="bg-white rounded-full p-1"><i data-lucide="instagram" class="w-5 h-5 text-red-600"></i></a>
                        <a href="#" class="bg-white rounded-full p-1"><i data-lucide="facebook" class="w-5 h-5 text-blue-800"></i></a>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-white/30">
                <h5 class="text-lg font-bold mb-2 text-white">LOCATIONS</h5>
                <p class="text-sm">
                    <a href="#">Medicas India</a> | 
                    <a href="#">Medicas Trinidad and Tobago</a> | 
                    <a href="#">Medicas Grenada</a> | 
                    <a href="#">Medicas Guyana</a> | 
                    <a href="#">Medicas Jamaica</a> | 
                    <a href="#">Medicas Barbados</a> | 
                    <a href="#">Medicas Dominica</a>
                </p>
            </div>
            
            <div class="mt-8 text-sm text-center border-t border-white/30 pt-4">
                <a href="#" class="mx-2 hover:text-white">Cities Index</a> | 
                <a href="#" class="mx-2 hover:text-white">Specialities Index</a> | 
                <a href="#" class="mx-2 hover:text-white">Symptoms Index</a> | 
                <a href="#" class="mx-2 hover:text-white">City Speciality Index</a> | 
                <a href="#" class="mx-2 hover:text-white">City Symptom Index</a>
            </div>
        </div>
    </footer>


    <script>
        // Store the base64 string of the uploaded media for simulating API calls and Telehealth display
        let uploadedMediaBase64 = null; 
        let predictedCondition = "General Consultation"; // Default condition for booking reason
        let uploadedMediaType = 'image'; // 'image' or 'video'
        let currentTranscript = ''; // Stores the mock transcript for Telehealth sharing
        let topMatches = []; // Stores the top 5 match scores

        // --- DATA STRUCTURES (SIMULATING BACKEND RESPONSE from scheduling.py) ---
        const FAKE_SLOT_DATA = {
            "Dermatology": [
                { "id": 1, "date": "2025-12-02", "time": "4:00 PM", "day": "Tuesday", "is_best_match": true, "doctorId": "DR_PIYUSH_GUPTA", "doctorName": "Dr. Piyush Gupta" },
                { "id": 2, "date": "2025-12-04", "time": "3:00 PM", "day": "Thursday", "is_best_match": false, "doctorId": "DR_PIYUSH_GUPTA", "doctorName": "Dr. Piyush Gupta" },
                { "id": 3, "date": "2025-12-05", "time": "2:00 PM", "day": "Friday", "is_best_match": false, "doctorId": "DR_PIYUSH_GUPTA", "doctorName": "Dr. Piyush Gupta" }
            ],
            "General Physician": [
                { "id": 4, "date": "2025-12-03", "time": "9:00 AM", "day": "Wednesday", "is_best_match": true, "doctorId": "DR_K_PATEL_GP", "doctorName": "Dr. K. Patel" },
                { "id": 5, "date": "2025-12-03", "time": "8:00 AM", "day": "Wednesday", "is_best_match": false, "doctorId": "DR_K_PATEL_GP", "doctorName": "Dr. K. Patel" },
                { "id": 6, "date": "2025-12-04", "time": "5:00 PM", "day": "Thursday", "is_best_match": false, "doctorId": "DR_K_PATEL_GP", "doctorName": "Dr. K. Patel" }
            ],
            "Pediatrics": [
                { "id": 7, "date": "2025-12-01", "time": "1:40 PM", "day": "Monday", "is_best_match": true, "doctorId": "DR_M_MOHAN", "doctorName": "Dr. M. Mohan" },
                { "id": 8, "date": "2025-12-01", "time": "2:10 PM", "day": "Monday", "is_best_match": false, "doctorId": "DR_M_MOHAN", "doctorName": "Dr. M. Mohan" }
            ],
            "Obstetrics Gynecology": [
                { "id": 9, "date": "2025-12-02", "time": "1:40 PM", "day": "Tuesday", "is_best_match": true, "doctorId": "DR_RK_SHARMA", "doctorName": "Dr. RK. Sharma" },
                { "id": 10, "date": "2025-12-03", "time": "11:00 AM", "day": "Wednesday", "is_best_match": false, "doctorId": "DR_RK_SHARMA", "doctorName": "Dr. RK. Sharma" }
            ]
        };

        // Current selected appointment state
        let selectedSlot = null;
        // The array to hold all future booked appointments
        let appointmentHistory = [];
        
        // --- API ENDPOINT BASE URL (MUST match the Flask port if running locally) ---
        const API_BASE_URL = 'http://127.0.0.1:5000/api';

        // --- UTILITY: DATE FORMATTING ---
        
        /**
         * Converts a YYYY-MM-DD string to a readable format (e.g., Tuesday, Dec 2nd).
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @returns {string} Readable date string.
         */
        function formatReadableDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        /**
         * Formats the date and time for the "Next available at" display on the dashboard.
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @param {string} timeStr - Time string (e.g., "4:00 PM").
         * @returns {string} Formatted string (e.g., "02-12-2025, 04:00 PM (IST)")
         */
        function formatNextAvailableTime(dateStr, timeStr) {
            const dateParts = dateStr.split('-');
            // Format to DD-MM-YYYY
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; 
            // Format time to HH:MM AM/PM
            const timeParts = timeStr.split(' ');
            let [hour, minute] = timeParts[0].split(':').map(Number);
            const ampm = timeParts[1];
            
            // Pad hour/minute if needed (e.g., 4:00 PM -> 04:00 PM)
            let hourStr = String(hour).padStart(2, '0');
            let minuteStr = String(minute).padStart(2, '0');
            
            return `${formattedDate}, ${hourStr}:${minuteStr} ${ampm} (IST)`;
        }

        // --- UI STATE AND NAVIGATION ---
        
        const views = {
            'dashboard': 'Patient Dashboard',
            'skin-check': 'AI Skin Disease Screening',
            'appointments': 'Schedule Appointment',
            'telehealth': 'Telehealth Session',
            'records': 'Medical Records',
            'refills': 'Prescription Refills Manager'
        };
        let currentView = 'dashboard';

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            changeView(currentView);
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    changeView(e.currentTarget.getAttribute('data-view'));
                });
            });

            document.getElementById('mobile-nav').addEventListener('change', (e) => {
                changeView(e.target.value);
            });
            
            // Initialize appointment slots on load
            loadSuggestedSlots(); 
            renderAppointmentList();
            
            // Load next available times for the new specialties grid
            loadNextAvailableSpecialtyTimes(); 
        });

        /**
         * Switches the active view/tab in the UI.
         */
        function changeView(newView) {
            currentView = newView;
            document.getElementById('page-title').textContent = views[newView] || 'Agentic AI Healthcare Portal';
            
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('tab-active');
            });

            const activeViewElement = document.getElementById(`${newView}-view`);
            if (activeViewElement) {
                activeViewElement.classList.remove('hidden');
            }

            const activeNavLink = document.querySelector(`.nav-link[data-view="${newView}"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('tab-active');
            }
            
            const mobileSelect = document.getElementById('mobile-nav');
            if (mobileSelect) {
                mobileSelect.value = newView;
            }
            
            window.scrollTo(0, 0); 
        }

        /**
         * Changes to the appointments view and pre-selects a specialty.
         */
        function changeViewAndSelectSpecialty(viewName, specialty) {
            changeView(viewName);
            document.getElementById('specialty-select').value = specialty;
            loadSuggestedSlots();
        }

        /**
         * Loads and displays the next available time for each major specialty on the dashboard.
         */
        async function loadNextAvailableSpecialtyTimes() {
            const specialties = [
                { id: 'gp-slot-time', specialty: 'General Physician' },
                { id: 'pediatrics-slot-time', specialty: 'Pediatrics' },
                { id: 'dermatology-slot-time', specialty: 'Dermatology' },
                { id: 'obgyn-slot-time', specialty: 'Obstetrics Gynecology' }
            ];

            for (const item of specialties) {
                const element = document.getElementById(item.id);
                try {
                    // Using simulated fetch
                    const slots = await fetchAvailableSlots(item.specialty); 

                    if (slots && slots.length > 0) {
                        const nextSlot = slots[0];
                        element.textContent = formatNextAvailableTime(nextSlot.date, nextSlot.time);
                    } else {
                        element.textContent = 'No slots available';
                    }
                } catch (error) {
                    // Fallback to initial mock if API simulation fails
                    const mockSlots = FAKE_SLOT_DATA[item.specialty] || [];
                    if (mockSlots.length > 0) {
                        element.textContent = formatNextAvailableTime(mockSlots[0].date, mockSlots[0].time);
                    } else {
                        element.textContent = 'Error loading/No slots';
                    }
                }
            }
        }
        
        /**
         * Placeholder for rescheduling logic: shows a modal and directs to appointments,
         * while also removing the old reminder alert from the dashboard.
         * @param {string} alertId - The ID of the HTML element (li) to remove.
         */
        function rescheduleAppointment(alertId) {
            // 1. Show the confirmation modal
            showModal(
                "Reschedule Appointment",
                "You will be redirected to the Appointments page to select a new time and date for your consultation. The old reminder will be cleared.",
                "indigo"
            );

            // 2. Remove the alert element from the dashboard instantly
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.remove(); // This physically removes the reminder from the dashboard view
            }
            
            // The hideModal function will handle the redirect to 'appointments' after acknowledge.
        }
        
        /**
         * Placeholder for Refill logic: shows a modal and directs to refills,
         * while also removing the yellow alert from the dashboard.
         * @param {string} alertId - The ID of the HTML element (li) to remove.
         */
        function requestRefillAction(alertId) {
            // 1. Show the confirmation modal
            showModal(
                "Refill Processing",
                "You will be redirected to the Refills Manager to complete the request. The action alert will be cleared from the dashboard.",
                "blue"
            );

            // 2. Remove the alert element from the dashboard instantly
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.remove(); // This physically removes the yellow alert from the dashboard view
            }
            
            // The hideModal function will handle the redirect to 'refills' after acknowledge.
        }

        // --- SCHEDULING LOGIC (API SIMULATION) ---

        /**
         * Fetches available slots for a given specialty from the simulated API.
         * NOTE: This function currently uses FAKE_SLOT_DATA to simulate the API behavior.
         */
        async function fetchAvailableSlots(specialty) {
            // console.log(`Simulating API call to fetch slots for: ${specialty} from ${API_BASE_URL}/slots`);
            
            // --- SIMULATED FETCH REQUEST ---
            await new Promise(resolve => setTimeout(resolve, 300)); // Simulate network latency
            
            // Return the mock data based on specialty:
            const slots = FAKE_SLOT_DATA[specialty] || [];
            return slots;
        }


        /**
         * Fetches slots and renders them. UPDATED to use fetchAvailableSlots().
         */
        async function loadSuggestedSlots() {
            const specialty = document.getElementById('specialty-select').value;
            const slotContainer = document.getElementById('slot-container');
            slotContainer.innerHTML = '<p class="text-gray-600 italic">Finding best slots...</p>';
            selectedSlot = null;
            document.getElementById('confirm-booking-btn').disabled = true;
            document.getElementById('confirm-booking-btn').textContent = 'Select a Slot to Confirm Booking';

            try {
                const slots = await fetchAvailableSlots(specialty);
                renderSuggestedSlots(slots);
            } catch (error) {
                slotContainer.innerHTML = '<p class="text-red-600 font-medium">Error connecting to scheduling service (using mock data).</p>';
            }
        }

        /**
         * Renders the suggested slots as clickable buttons with readable dates.
         */
        function renderSuggestedSlots(slots) {
            const slotContainer = document.getElementById('slot-container');
            slotContainer.innerHTML = ''; 

            if (!slots || slots.length === 0) {
                slotContainer.innerHTML = '<p class="text-red-600 font-medium">No available slots found for this specialty next week.</p>';
                return;
            }

            slots.forEach(slot => {
                const button = document.createElement('button');
                button.className = `slot-btn`;
                button.setAttribute('data-slot', JSON.stringify(slot));
                
                // --- IMPROVED DATE DISPLAY ---
                const readableDate = formatReadableDate(slot.date);
                let buttonText = `${readableDate}, ${slot.time}`;
                if (slot.is_best_match) {
                    buttonText += ' (BEST MATCH)';
                }

                button.textContent = buttonText;
                
                // Add click listener to select the slot
                button.addEventListener('click', () => selectSlot(button, slot));
                
                slotContainer.appendChild(button);
            });
            
            // Automatically select the best match slot on load
            const bestMatchButton = slotContainer.querySelector('.slot-btn:first-child');
            if (bestMatchButton) {
                selectSlot(bestMatchButton, JSON.parse(bestMatchButton.getAttribute('data-slot')));
            }
            lucide.createIcons();
        }

        /**
         * Selects a slot and updates the confirmation button.
         */
        function selectSlot(button, slot) {
            // Deselect all buttons
            document.querySelectorAll('.slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select the clicked button
            button.classList.add('selected');

            selectedSlot = slot;
            const confirmBtn = document.getElementById('confirm-booking-btn');
            confirmBtn.disabled = false;
            
            // Use the readable date for the confirmation button
            const readableDate = formatReadableDate(slot.date);
            confirmBtn.textContent = `Confirm Booking (${readableDate}, ${slot.time})`;
        }

        /**
         * Simulates appointment confirmation by sending data to the backend API.
         * NOTE: This simulates the API POST call for booking.
         */
        async function showConfirmation() {
            if (!selectedSlot) {
                showModal("Error", "Please select an appointment slot first.", "red");
                return;
            }

            // --- SIMULATE DUPLICATE CHECK LOCALLY (for demo purposes) ---
            const isDuplicate = appointmentHistory.some(app => 
                app.date === selectedSlot.date && app.time === selectedSlot.time
            );

            if (isDuplicate) {
                showModal("Duplicate Appointment", "You already have an appointment booked for this exact date and time. Please choose a different slot.", "amber");
                return;
            }
            
            const appointmentDetails = {
                slot_id: selectedSlot.id,
                doctor_id: selectedSlot.doctorId,
                date: selectedSlot.date,
                time: selectedSlot.time,
                specialty: document.getElementById('specialty-select').value,
                doctorName: selectedSlot.doctorName,
                patient_id: document.getElementById('user-id-display').textContent || 'ANON_USER',
                predictedCondition: predictedCondition,
                mediaType: uploadedMediaType,
                transcript: currentTranscript
            };

            console.log("Simulating API POST request to book slot:", appointmentDetails);

            try {
                // --- SIMULATED API POST REQUEST ---
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // --- SUCCESSFUL CLIENT-SIDE UPDATE ---
                appointmentHistory.push(appointmentDetails); 
                renderAppointmentList();

                // Update Telehealth view
                document.getElementById('telehealth-doctor').textContent = `${selectedSlot.doctorName} (${selectedSlot.specialty})`;
                document.getElementById('telehealth-datetime').textContent = `${formatReadableDate(selectedSlot.date)}, ${selectedSlot.time}`;
                document.getElementById('telehealth-id').textContent = selectedSlot.id;

                const readableDate = formatReadableDate(selectedSlot.date);
                showModal("Appointment Confirmed!", `Your session with ${selectedSlot.doctorName} is booked for ${readableDate} at ${selectedSlot.time}.`, "indigo");
                
            } catch (error) {
                console.error("Booking failed:", error);
                showModal("Booking Failed", error.message || "Could not confirm appointment. Please try again later.", "red");
                return;
            }
            
            // Reset selection state
            selectedSlot = null;
            document.getElementById('confirm-booking-btn').disabled = true;
            document.getElementById('confirm-booking-btn').textContent = 'Select a Slot to Confirm Booking';
            loadSuggestedSlots(); // Refresh slots
            loadNextAvailableSpecialtyTimes(); // Update dashboard times
        }
        
        /**
         * REMOVE APPOINTMENT FUNCTIONALITY (FIX)
         */
        function cancelAppointment(appointmentId) {
            // Find the index of the appointment to cancel
            const index = appointmentHistory.findIndex(app => app.id === appointmentId);
            
            if (index !== -1) {
                const app = appointmentHistory[index];
                
                // Remove the appointment from the array
                appointmentHistory.splice(index, 1);
                
                // Re-render the list
                renderAppointmentList();
                
                showModal("Cancellation Success", `Appointment with ${app.doctorName} on ${formatReadableDate(app.date)} has been cancelled.`, "amber");
            }
        }
        
        /**
         * Renders the list of appointments in the sidebar.
         */
        function renderAppointmentList() {
            const list = document.getElementById('appointment-list');
            list.innerHTML = '';

            // Add upcoming appointments
            appointmentHistory.forEach(app => {
                const readableDate = formatReadableDate(app.date);
                const listItem = document.createElement('li');
                listItem.className = 'p-3 bg-white rounded-lg border flex justify-between items-center shadow-sm';
                listItem.innerHTML = `
                    <div>
                        <p class="font-medium text-emerald-600">Upcoming: ${app.doctorName}</p>
                        <p class="text-sm text-gray-500">${readableDate}, ${app.time} (${app.specialty})</p>
                        <p class="text-xs text-gray-400">AI Predicted: ${app.predictedCondition}</p>
                    </div>
                    <button 
                        class="text-red-500 hover:text-red-700 text-sm font-semibold" 
                        onclick="cancelAppointment('${app.id}')"
                    >
                        Cancel
                    </button>
                `;
                list.appendChild(listItem);
            });
            
            // Add static 'Completed' item (Placeholder for history)
            list.innerHTML += `
                <li class="p-3 bg-white rounded-lg border flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-medium text-gray-600">Completed: Dr. K. Patel</p>
                        <p class="text-sm text-gray-500">15 Nov, 11:00 AM (GP)</p>
                    </div>
                    <button class="text-primary-color hover:text-indigo-700 text-sm" onclick="changeView('records')">View Record</button>
                </li>
            `;
            lucide.createIcons();
        }
        
        // --- REFILL LOGIC (In Refill View) ---
        
        /**
         * Handles the click event for requesting a refill *inside* the Refills view.
         */
        function requestRefill(medicineName, elementId) {
            const refillItem = document.getElementById(elementId);
            const button = refillItem.querySelector('.refill-btn');
            
            // Simulate processing
            button.textContent = 'Processing...';
            button.disabled = true;
            button.classList.remove('bg-yellow-600', 'bg-green-600', 'hover:bg-yellow-700', 'hover:bg-green-700');
            button.classList.add('bg-gray-400');
            
            setTimeout(() => {
                // Change style to 'Pending Approval'
                refillItem.classList.remove('bg-yellow-50', 'bg-green-50', 'border-yellow-300', 'border-green-300');
                refillItem.classList.add('bg-blue-50', 'border-blue-300');
                
                button.textContent = 'Pending Approval';
                button.disabled = true;
                button.classList.remove('bg-gray-400');
                button.classList.add('bg-blue-600');
                
                showModal("Refill Requested", `${medicineName} refill request has been sent to the doctor for approval. You will be notified shortly.`, "blue");
                // Note: No changeView here, as we are already on the refills page.
            }, 1000);
        }

        // --- AI PREDICTION LOGIC (INTEGRATED AND RELIABLE) ---

        // Disease keywords based on the uploaded text files
        const DISEASE_KEYWORDS = {
            "Melanoma (High Concern)": ["asymmetry", "irregular border", "uneven color", "color variation", "multiple colors", "diameter larger than 6mm", "evolving", "changing size", "changing shape"],
            "Actinic Keratosis": ["rough patch", "sandpaper texture", "scaly patch", "dry adherent scales", "reddish area", "precancerous", "sun damage"],
            "Basal Cell Carcinoma": ["pearly bump", "waxy bump", "translucent", "pink growth", "raised edges", "indented center", "rolled border", "visible blood vessels", "open sore", "non-healing lesion"],
            "Seborrheic Keratosis": ["stuck on appearance", "pasted on", "waxy look", "wart-like", "rough warty surface", "barnacles of old age", "crusty", "itchy", "brownish", "raised"],
            "Squamous Cell Carcinoma": ["firm red nodule", "persistent scaly patch", "crusty lesion", "elevated lesion", "wart-like growth", "open sore that crusts", "bleeds easily"],
            "Nevus (Common Mole)": ["symmetrical", "uniform color", "one color", "even color", "smooth border", "regular border", "stable", "not changing", "common mole"],
            "Dermatofibroma": ["dimple sign", "buttonhole sign", "pinches inward", "firm bump", "feels like a stone", "attached to deep skin"],
            "Vascular Lesion": ["cherry angioma", "spider veins", "hemangioma", "red spot", "purple marks", "blueish hue", "cluster of blood vessels", "port-wine stain"],
            "Pigmented Benign Keratosis": ["age spot", "liver spot", "solar lentigo", "flat brown spot", "homogenous brown", "macular hyperpigmented", "well-defined border", "sun exposure"]
        };
        
        // Mock transcription examples (mimics Whisper output)
        const MOCK_TRANSCRIPT_EXAMPLES = [
            "I have a dark spot that is asymmetric and has an irregular border. I also see color variation in it. It's changing shape.", // Strong Melanoma match
            "I've got a waxy bump that is translucent, almost like a pearly bump, and I see visible blood vessels. It won't heal.", // Strong Basal Cell Carcinoma match
            "This patch feels like rough sandpaper texture and is a scaly patch that I got from sun damage on my arm.", // Strong Actinic Keratosis match
            "It's just a common mole that's symmetrical and stable, but I wanted to make sure it's okay.", // Strong Nevus match
            "The spot has a stuck on appearance. It's raised, brownish, and feels rough, almost like a barnacles of old age.", // Strong Seborrheic Keratosis match
        ];
        
        /**
         * Core keyword matching logic based on Disease_match.py.
         */
        function matchKeywordsToDisease(transcript) {
            if (!transcript) return [];
            
            const normalizedTranscript = transcript.toLowerCase().replace(/[^a-z0-9\s]/g, ' ');
            let allMatches = [];
            
            for (const disease in DISEASE_KEYWORDS) {
                const keywords = DISEASE_KEYWORDS[disease];
                let exactMatchScore = 0;
                
                // Calculate Exact Match Score (High Weight: 10 points per exact phrase match)
                keywords.forEach(keyword => {
                    if (normalizedTranscript.includes(keyword.toLowerCase())) {
                        exactMatchScore += 10; 
                    }
                });

                // Calculate Fuzzy Match Simulation (Mimics complex NLP scoring)
                const fuzzy_score_sim = Math.random() * 50 + 30; // 30-80 baseline
                
                // Final Score: Weighted Exact Match + Fuzzy Baseline
                const total_score = exactMatchScore * 5 + fuzzy_score_sim; 
                
                // Confidence %: Normalize the score 
                const confidence = Math.min(98.0, 50.0 + total_score / 15);
                
                if (total_score > 30) {
                    allMatches.push({
                        disease: disease,
                        confidence: Math.round(confidence * 10) / 10,
                        exact_score: exactMatchScore,
                        total_score: Math.round(total_score)
                    });
                }
            }
            
            // Sort by confidence (descending)
            allMatches.sort((a, b) => b.confidence - a.confidence);
            
            return allMatches;
        }


        /**
         * Simulates an API call to the AI Prediction service (now integrated).
         */
        async function runAIPrediction(inputData) {
            
            // 1. Simulate prediction time delay
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            let result = { status: "success", allMatches: [] };
            
            if (inputData.mediaType === 'video') {
                // --- VIDEO PREDICTION PATH (Keyword/Similarity Match) ---
                const transcript = inputData.transcript;
                const all_matches = matchKeywordsToDisease(transcript);
                
                if (all_matches.length === 0) {
                    return { status: "error", message: "No relevant keywords found in audio description." };
                }

                const best_match = all_matches[0];
                
                result.predicted_condition = best_match.disease;
                result.confidence_percent = best_match.confidence;
                result.transcript_text = transcript;
                result.allMatches = all_matches;
                
                // Determine Severity
                let severity = "Mild";
                let color = "indigo";
                let recommendation_text = "General practitioner consultation for initial assessment.";
                
                if (best_match.disease.includes("Melanoma") || best_match.disease.includes("Carcinoma")) {
                    severity = "Urgent";
                    color = "red";
                    recommendation_text = `Immediate specialist appointment suggested due to high-risk keyword score.`;
                } else if (best_match.exact_score > 10) { 
                    severity = "Moderate";
                    color = "amber";
                    recommendation_text = `Specialist consultation recommended based on the key descriptive phrase(s) found in the verbal description.`;
                }

                result.severity = severity;
                result.color = color;
                result.recommendation_text = recommendation_text;
                
                console.log("--- AI VIDEO ANALYSIS RESULT (Simulated Match) ---", result);

            } else {
                // --- IMAGE PREDICTION PATH (VGG19 Mock) ---
                const MOCK_IMAGE_PREDICTIONS = [
                    {"predicted_condition": "Psoriasis", "confidence_percent": 96.8, "severity": "Moderate", "recommendation_text": "Specialist consultation recommended.", "color": "amber", "allMatches": [
                        { "disease": "Psoriasis", "confidence": 96.8 },
                        { "disease": "Eczema (Mock)", "confidence": 85.2 },
                        { "disease": "Seborrheic Keratosis", "confidence": 78.0 },
                        { "disease": "Actinic Keratosis", "confidence": 65.5 },
                        { "disease": "Vascular Lesion", "confidence": 55.1 }
                    ]},
                    {"predicted_condition": "Basal Cell Carcinoma", "confidence_percent": 91.0, "severity": "Urgent", "recommendation_text": "High-priority consultation with a specialist required immediately.", "color": "red", "allMatches": [
                        { "disease": "Basal Cell Carcinoma", "confidence": 91.0 },
                        { "disease": "Squamous Cell Carcinoma", "confidence": 85.0 },
                        { "disease": "Melanoma (High Concern)", "confidence": 70.2 },
                        { "disease": "Nevus (Common Mole)", "confidence": 55.9 },
                        { "disease": "Dermatofibroma", "confidence": 45.0 }
                    ]},
                ];
                
                result = MOCK_IMAGE_PREDICTIONS[Math.floor(Math.random() * MOCK_IMAGE_PREDICTIONS.length)];
                result.status = "success";
                result.transcript_text = null;
                console.log("--- AI IMAGE ANALYSIS RESULT (Simulated VGG19) ---", result);
            }
            
            return result;
        }
        
        /**
         * Renders the top 5 predicted diseases in the UI.
         */
        function renderTopMatches(matches) {
            const listElement = document.getElementById('top-matches-list');
            listElement.innerHTML = ''; // Clear previous list

            if (!matches || matches.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500">No matches yet.</li>';
                return;
            }

            // Take only the top 5 matches
            const top5 = matches.slice(0, 5);

            top5.forEach((match, index) => {
                const listItem = document.createElement('li');
                // Use custom CSS class for visual hierarchy (Top 1, Top 2, etc.)
                const rankClass = index === 0 ? 'text-indigo-700 font-bold' : (index === 1 ? 'text-emerald-600' : (index === 2 ? 'text-orange-500' : 'text-gray-600'));
                
                listItem.className = `flex justify-between items-center ${rankClass}`;
                listItem.innerHTML = `
                    <span>${index + 1}. ${match.disease}</span>
                    <span class="font-mono text-sm">${match.confidence}%</span>
                `;
                listElement.appendChild(listItem);
            });
            lucide.createIcons();
        }

        /**
         * Updates the AI results card based on the prediction.
         */
        function updateAIResults(predictionResult) {
            const conditionElement = document.getElementById('ai-prediction-condition');
            const confidenceElement = document.getElementById('ai-prediction-confidence');
            const severityElement = document.getElementById('ai-severity');
            const recommendationElement = document.getElementById('ai-recommendation');
            const resultCard = document.getElementById('ai-result-card');
            const transcriptDisplay = document.getElementById('transcript-display');

            // Reset prediction display
            conditionElement.textContent = 'N/A';
            confidenceElement.textContent = '0%';
            severityElement.textContent = 'N/A';
            recommendationElement.textContent = 'Disclaimer: This is NOT a diagnosis. Always consult a licensed medical professional.';
            transcriptDisplay.classList.add('hidden');
            resultCard.className = 'md:col-span-2 bg-primary-color/10 p-6 rounded-xl border border-primary-color/30 shadow-inner';
            
            // Re-apply correct base class for severity box
            const severityDiv = document.getElementById('severity-box');
            severityDiv.className = 'bg-white p-3 rounded-lg border-l-4 severity-default';

            // Reset top matches list
            document.getElementById('top-matches-list').innerHTML = '<li class="text-gray-500">No matches yet.</li>';


            if (predictionResult.status === 'success') {
                const { predicted_condition, confidence_percent, severity, recommendation_text, color, transcript_text, allMatches } = predictionResult;
                
                predictedCondition = predicted_condition; // Update global variable for booking reason
                
                conditionElement.textContent = predicted_condition;
                confidenceElement.textContent = `${confidence_percent}%`;
                severityElement.textContent = severity;
                recommendationElement.textContent = recommendation_text;
                
                // --- RENDER TOP MATCHES ---
                renderTopMatches(allMatches || []);
                
                // Update styling based on severity color
                resultCard.classList.remove('bg-indigo-50', 'bg-red-50', 'bg-amber-50');
                resultCard.classList.add(`bg-${color}-50`); 
                
                severityDiv.classList.remove('severity-urgent', 'severity-moderate', 'severity-default');

                if (color === 'red') {
                    severityDiv.classList.add('severity-urgent');
                    resultCard.classList.add('border-red-200');
                } else if (color === 'amber') {
                    severityDiv.classList.add('severity-moderate');
                    resultCard.classList.add('border-yellow-200');
                } else {
                    severityDiv.classList.add('severity-default');
                    resultCard.classList.add('border-primary-color/30');
                }
                
                // Display transcript if available
                if (transcript_text) {
                    transcriptDisplay.classList.remove('hidden');
                    document.getElementById('extracted-text').textContent = transcript_text;
                }

                // **FIX: Re-add automatic follow-up (reason-for-visit) logic**
                document.getElementById('reason-for-visit').value = `Follow-up on AI prediction: ${predicted_condition} (${severity} concern).`;
                
                // Suggest Dermatology specialty if it's a skin issue
                document.getElementById('specialty-select').value = 'Dermatology';
                loadSuggestedSlots(); // Reload slots based on new selection
                
            } else {
                // Handle prediction error
                conditionElement.textContent = "Analysis Failed";
                document.getElementById('loading-indicator').classList.add('hidden'); 
                document.getElementById('prediction-results').classList.remove('hidden'); 
                showModal("Analysis Error", predictionResult.message || "Could not process media. Please try again.", "red");
            }
        }
        
        /**
         * Simulates Whisper transcription for a video/audio file.
         */
        async function simulateTranscription(file) {
            // Simulate the Whisper model running (takes longer)
            document.getElementById('loading-message').textContent = "Processing video with Whisper model for transcription...";
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Choose a random mock transcript example
            const transcript = MOCK_TRANSCRIPT_EXAMPLES[Math.floor(Math.random() * MOCK_TRANSCRIPT_EXAMPLES.length)];
            
            document.getElementById('loading-message').textContent = "Transcription complete. Running keyword analysis...";
            return transcript;
        }

        /**
         * Handles the file upload event, shows preview, and simulates AI prediction.
         */
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showModal("File Too Large", "Please upload an image or video smaller than 5MB.", "red");
                event.target.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const mediaUrl = e.target.result;
                
                // 1. Determine media type and show appropriate preview
                uploadedMediaBase64 = mediaUrl;
                let isVideo = file.type.startsWith('video');
                uploadedMediaType = isVideo ? 'video' : 'image';
                
                const imagePreview = document.getElementById('image-preview');
                const videoPreview = document.getElementById('video-preview');
                const mediaTitle = document.getElementById('media-title');

                if (isVideo) {
                    imagePreview.classList.add('hidden');
                    videoPreview.classList.remove('hidden');
                    videoPreview.src = mediaUrl;
                    mediaTitle.textContent = "Your Upload (Video)";
                } else {
                    videoPreview.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    imagePreview.src = mediaUrl;
                    mediaTitle.textContent = "Your Upload (Image)";
                }

                // 2. Show Loading and Preparation
                document.getElementById('upload-container').classList.add('hidden');
                document.getElementById('prediction-results').classList.add('hidden'); 
                document.getElementById('loading-indicator').classList.remove('hidden'); 
                document.getElementById('loading-message').textContent = `Uploading ${uploadedMediaType}...`;
                
                // 3. Prepare data for prediction
                let predictionData = { mediaType: uploadedMediaType };
                let base64DataOnly = mediaUrl.split(',')[1];
                
                currentTranscript = '';

                if (isVideo) {
                    // Simulate Whisper transcription first
                    currentTranscript = await simulateTranscription(file);
                    predictionData.transcript = currentTranscript;
                } else {
                    // Image analysis uses base64 data
                    document.getElementById('loading-message').textContent = "Analyzing image with VGG19 model... Please wait.";
                    predictionData.image_data = base64DataOnly;
                }

                // 4. Run Prediction
                try {
                    const prediction = await runAIPrediction(predictionData);
                    updateAIResults(prediction);
                } catch (error) {
                    console.error("AI Prediction failed:", error);
                    updateAIResults({ status: 'error', message: 'Network or server error during analysis.' });
                } finally {
                    // 5. Hide Loading and Show Results
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('prediction-results').classList.remove('hidden'); 
                    lucide.createIcons();
                }
            };
            reader.readAsDataURL(file);
        }

        /**
         * Shows a custom modal with a title and message.
         */
        function showModal(title, message, color = 'indigo') {
            // Mapping custom colors for utility classes
            const colorMap = {
                'indigo': 'primary-color', // Use custom primary color
                'red': 'red',
                'amber': 'yellow',
                'blue': 'blue'
            };
            const lucideIcon = color === 'red' ? 'x-circle' : 'check-circle';
            const tailwindColor = colorMap[color] || 'primary-color';

            document.getElementById('modal-title').innerHTML = `<i data-lucide="${lucideIcon}" class="w-6 h-6 mr-2"></i> ${title}`;
            document.getElementById('modal-message').textContent = message;
            
            const modalTitleElement = document.getElementById('modal-title');
            
            // Reset and apply title color
            modalTitleElement.classList.forEach(cls => {
                if (cls.startsWith('text-') && !cls.includes('primary-color')) modalTitleElement.classList.remove(cls);
            });
            if(tailwindColor === 'primary-color') {
                modalTitleElement.classList.add('text-primary-color');
            } else {
                modalTitleElement.classList.add(`text-${tailwindColor}-600`);
            }

            const modalButton = document.querySelector('#custom-modal button');
            // Reset and apply button color
            modalButton.classList.forEach(cls => {
                if (cls.startsWith('bg-') && !cls.includes('primary-color')) modalButton.classList.remove(cls);
            });
            if(tailwindColor === 'primary-color') {
                 modalButton.classList.add('bg-primary-color', 'hover:bg-indigo-700');
            } else {
                modalButton.classList.add(`bg-${tailwindColor}-600`, `hover:bg-${tailwindColor}-700`);
            }
            
            document.getElementById('custom-modal').classList.remove('hidden');
            lucide.createIcons(); 
        }

        /**
         * Hides the custom modal.
         */
        function hideModal() {
            const modalTitle = document.getElementById('modal-title').textContent;
            document.getElementById('custom-modal').classList.add('hidden');
            
            // Check if the modal was for rescheduling or refill, if so, redirect to the respective page
            if (modalTitle.includes("Reschedule Appointment")) {
                changeView('appointments');
            } else if (modalTitle.includes("Refill Processing")) {
                changeView('refills');
            } else if (modalTitle.includes("Confirmed")) {
                changeView('dashboard');
            }
        }
        
        // Ensure all lucide icons are created on load
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>

</body>
</html>